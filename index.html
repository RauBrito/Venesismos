<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="index.css"></script>

    <style>
      #map {
        height: 100vh;
      }
    </style>
  </head>
  <body class="w-[100vw] h-[100vh] bg-neutral-800">
    <div class="w-full h-full flex flex-col gap-4 relative">
      <!-- <h1 class="text-black text-4xl font-bold" >Terremotos</h1> -->

      <div class="w-[100vw] h-[100vh] z-5">
        <div id="map"></div>
      </div>
      <div
        class="absolute top-4 right-4 w-12 h-12 bg-neutral-100 z-10 rounded-md border-neutral-500 border cursor-pointer flex items-center justify-center"
        id="btn-modal"
      >
        <ion-icon name="options-outline" class="w-5 h-5 m-0 "></ion-icon>
      </div>

      <div
        class="absolute top-20 right-4 p-4 bg-neutral-100 z-10 rounded-md border-neutral-500 border cursor-pointer hidden flex-col"
        id="modal"
      >
        <div class="flex flex-col w-full gap-4 items-end">
          <div class="flex flex-col gap-2">
            <p class="text-black font-semibold font-sans">Desde:</p>
            <input
              type="date"
              id="date-start"
              class="border-neutral-500 border placeholder-neutral-400 px-4 py-2 rounded-sm text-black"
              value="2025-09-20"
              />
            </div>
            <div class="flex flex-col gap-2">
              <p class="text-black font-semibold font-sans">Hasta:</p>
              <input
              type="date"
              id="date-end"
              class="border-neutral-500 border placeholder-neutral-400 px-4 py-2 rounded-sm text-black"
              value="2025-09-30"
            />
          </div>
          <button
            id="btn"
            class="px-8 py-2 bg-sky-500 text-neutral-100 rounded-sm cursor-pointer w-full mt-2 border-sky-800 border"
          >
            Mostrar
          </button>
        </div>
      </div>
    </div>

    <script>
      // Map Logic
      var map = L.map("map").setView([8.1, -66.97], 6);

      const tiles = L.tileLayer(
        "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }
      );
      tiles.addTo(map);

    //   function onMapClick(e) {
    //     const { lat, lng } = e.latlng;
    //     L.marker([lat, lng]).addTo(map);
    //     alert("You clicked the map at " + e.latlng);
    //   }

    //   map.on("click", onMapClick);

      const circlePopup = (place, mag, date) => {
        return `
    <h5 class="text-lg font-semibold" >${place}</h5>
    <p class="text-base " >Magnitud: ${mag}</p>
    <p class="text-base " >${date}</p>
    `;
      };

      // lat lng
      // (14,-75)lt
      // (0,-75)lb

      // (14,-58)rt
      // (0,-58)rb

      const api_url_format = (start, end) => {
        const minlat = "&minlatitude=0";
        const minlng = "&minlongitude=-75";
        const maxlat = "&maxlatitude=14";
        const maxlng = "&maxlongitude=-58";
        return `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${start}&endtime=${end}${minlat}${minlng}${maxlat}${maxlng}`;
      };

      const getData = async (start = "2025-09-20", end = "2025-09-30") => {
        map.eachLayer((layer) => {
          layer.remove();
        });
        tiles.addTo(map);

        const res = await fetch(api_url_format(start, end));
        const data = await res.json();

        // console.log(data);

        for (let i = 0; i < data.features.length; i++) {
          let feat = data.features[i];
          const radius = feat.properties.mag * 1.5;
          const lat = feat.geometry.coordinates[1];
          const lng = feat.geometry.coordinates[0];
          // console.log(lat,lng,i);

          const circle = L.circleMarker([lat, lng], {
            radius,
            color: "red",
            fillColor: "#f03",
            fillOpacity: 0.5,
            radius:10,
          }).addTo(map);
          // circle.setLatLng([lat,lng])

          let dateMs = new Date(feat.properties.time);
          let date = dateMs.toUTCString();

          const place = feat.properties.place;
          const mag = feat.properties.mag;
          circle.bindPopup(circlePopup(place, mag, date));
        //   console.log(circle._events);
        }
      };
      const btn = document.getElementById("btn");
      btn.onclick = async () => {
        let start = document.getElementById("date-start").value;
        let end = document.getElementById("date-end").value;

        //   if(btn.classList.contains("bg-sky-500")){
        //     btn.classList.replace("bg-sky-500","bg-neutral-600")
        //   }else btn.classList.replace("bg-neutral-600","bg-sky-500")

        btn.setAttribute("disabled", true);
        btn.textContent = "Cargando...";
        await getData(start, end);
        btn.setAttribute("disabled", false);
        btn.textContent = "Mostrar";
      };

      getData();

      /// Modal Logic
      const modal = document.getElementById("modal");
      document.getElementById("btn-modal").onclick = () => {
        if (modal.classList.contains("flex")) {
          modal.classList.replace("flex", "hidden");
        } else modal.classList.replace("hidden", "flex");
      };
    </script>
  </body>
</html>
